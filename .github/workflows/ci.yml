# Automatically build the project and run any configured tests for every push
# and submitted pull request. This can help catch issues that only occur on
# certain platforms or Java versions, and provides a first line of defence
# against bad commits.

name: build
on:
  - push
  - pull_request

permissions:
  issues: write
  checks: write
  contents: write
  pull-requests: write

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: "‚¨áÔ∏è Checkout"
        uses: actions/checkout@v6

      - name: Determine Version
        id: version
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          GRADLE_PUBLISH_KEY: ${{ vars.GRADLE_PUBLISH_KEY }}
          GRADLE_PUBLISH_SECRET: ${{ secrets.GRADLE_PUBLISH_SECRET }}
          MEZA_MAVEN_USER: ${{ secrets.MEZA_MAVEN_USER }}
          MEZA_MAVEN_PASSWORD: ${{ secrets.MEZA_MAVEN_PASSWORD }}
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        uses: cycjimmy/semantic-release-action@v4
        with:
          dry_run: true
          extra_plugins: |
            @semantic-release/changelog@6.0.0
            semantic-release-discord-notifier 
            @meza/mezas-conventional-changelog
            conventional-changelog-conventionalcommits 
            @semantic-release/changelog 
            gradle-semantic-release-plugin

      - name: Update gradle.properties version
        if: steps.version.outputs.new_release_published == 'true'
        run: |
          VERSION="${{ steps.version.outputs.new_release_version }}"
          if [ -z "$VERSION" ]; then
            echo "No new_release_version found, using default version."
            exit 1
          fi
          sed -i "s/^version=.*/version=$VERSION/" gradle.properties
        shell: bash
        working-directory: ${{ github.workspace }}
        # This step updates the version in gradle.properties using the semantic-release output

      - name: "‚òï Setup Jdk 21"
        uses: actions/setup-java@v5
        with:
          cache: 'gradle'
          cache-dependency-path: |
            *.properties
            *.gradle.kts
          java-version: |
            21
          check-latest: true
          distribution: 'temurin'
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          validate-wrappers: true

      - name: Cache Gradle Test dependencies
        id: cache-gradle-dependencies
        uses: actions/cache@v4
        with:
          path: |
            build/e2e_tests/home
            build/e2e_tests/project/.gradle
          key: ${{ runner.os }}-gradle-${{ hashFiles('src/test/resources/**/*.gradle*') }}

      - name: "üß™ Run tests"
        run: ./gradlew build --stacktrace --no-configuration-cache

      - name: Upload build reports
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: build-reports
          path: |
            **/build/reports/
            **/build/test-results/
            **/build/e2e_tests/project/build/reports/
            **/build/e2e_tests/project/build/test-results/

      - name: Semantic Release to channel ${{ steps.version.outputs.new_release_channel }}
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          GRADLE_PUBLISH_KEY: ${{ vars.GRADLE_PUBLISH_KEY }}
          GRADLE_PUBLISH_SECRET: ${{ secrets.GRADLE_PUBLISH_SECRET }}
          MEZA_MAVEN_USER: ${{ secrets.MEZA_MAVEN_USER }}
          MEZA_MAVEN_PASSWORD: ${{ secrets.MEZA_MAVEN_PASSWORD }}
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          STONECRAFT_PRERELEASE: ${{ steps.version.outputs.new_release_channel == 'SNAPSHOT' }}
        uses: cycjimmy/semantic-release-action@v4
        with:
          extra_plugins: |
            @semantic-release/changelog@6.0.0
            semantic-release-discord-notifier 
            conventional-changelog-conventionalcommits
            @meza/mezas-conventional-changelog
            @semantic-release/changelog 
            gradle-semantic-release-plugin
